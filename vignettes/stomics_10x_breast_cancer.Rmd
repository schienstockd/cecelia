---
title: "Run modules"
output: html_document
date: '2022-08-16'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Examples to run functions and modules

```{r}
# set test variables
pID <- "5g6H4F"
versionID <- 1
projectsDir <- "/Volumes/Analysis_SSD/Dominik/cecelia/projects/"
```

```{r}
anaDir <- "/Volumes/USER_data/Dominik/Experiments/stomics/10x/ANALYSIS"
```

```{r}
# Load cluster data
devtools::load_all("../")
cciaUse("~/Desktop/DOHERTY/cecelia")

library(ggplot2)
library(tidyverse)
```

```{r}
# HPC config
HPC_CONF <-  list(
  hpc = list(
    conf = list(
      email = "schienstockd@student.unimelb.edu.au",
      emailOnBegin = FALSE,
      emailOnEnd = FALSE,
      emailOnFail = TRUE,
      numNodes = 1,
      numTasks = 1,
      numCPUperTask = 1,
      numGPUperTask = 1,
      memory = 50,
      walltime = "00-04:00:00",
      # walltime = "01-00:00:00",
      projectPartitions = "physical",
      projectID = "punim1124",
      useGPU = FALSE
      # projectPartitions = "gpu-a100",
      # projectID = "punim1031",
      # useGPU = TRUE
    )
  ),
  utils = list(
    ssh = list(
      username = "schienstockd",
      address = "spartan.hpc.unimelb.edu.au",
      keyfile = "/Users/schiend/.ssh/spartan_rsa"
    ),
    python = list(
      condaEnv = cciaConf()$python$conda$source$env
    )
  )
)
```

```{r}
# upload STOMICS
devtools::load_all("../")
cciaUse("~/Desktop/DOHERTY/cecelia", initConda = FALSE, projectsDir = projectsDir)

# init ccia object
cciaObj <- initCciaObject(
  pID = pID, uID = "aSf5Rr", versionID = versionID, initReactivity = FALSE 
)

# run cellpose
# run task
funParams <- list(
)

# run task
task <- cciaObj$runTask(
  funName = "hpc.uploadCciaObj",
  funParams = funParams,
  envVars = HPC_CONF,
  hpcDir = paste(hpcDir, pID, "ANALYSIS", sep = "/"),
  env = "local",
  runInplace = TRUE,
  taskID = 1
)
```


```{r}
# upload STOMICS
devtools::load_all("../")
cciaUse("~/Desktop/DOHERTY/cecelia", initConda = FALSE, projectsDir = projectsDir)

# init ccia object
cciaObj <- initCciaObject(
  pID = pID, uID = "aSf5Rr", versionID = versionID, initReactivity = FALSE 
)

# run cellpose
# run task
funParams <- list(
  valueName = "default",
  # valueName = "stroma",
  models = list(
    # "1" = list(
    #   "model" = "ccia.fluo",
    #   "matchAs" = "none",
    #   "cellDiameter" = 10,
    #   "cellChannels" = list("ALDH1 A3", "GJB2", "LUM", "MMP2", "POSTN", "SFRP4"),
    #   "nucChannels" = list(),
    #   "normalise" = 95,
    #   "stitchThreshold" = 0.2,
    #   # "mergeLabels" = FALSE,
    #   "mergeLabels" = TRUE,
    #   "threshold" = 1,
    #   "relTreshold" = 0,
    #   "gaussianFilter" = 0,
    #   "medianFilter" = 0
    # )
    # "1" = list(
    #   "model" = "cyto2",
    #   "matchAs" = "cyto",
    #   # "matchAs" = "none",
    #   "cellDiameter" = 10,
    #   "cellChannels" = list(
    #     "APOC1", "C15orf48", "C1QA", "C1QC", "CD14",
    #     "CD163", "CD68", "FGL2", "ITGAX", "MMP12",
    #     "CCR7", "CD83", "IL3RA", "LILRA4", "PLD4",
    #     "BANK1", "CD79A", "MS4A1", "CCL5", "CD4",
    #     "CD8A", "CXCR4", "CYTIP", "LTB", "TRAC"),
    #   "nucChannels" = list("Hoechst"),
    #   "normalise" = 99,
    #   "stitchThreshold" = 0.2,
    #   "mergeLabels" = FALSE,
    #   "threshold" = 1,
    #   "relTreshold" = 0,
    #   "gaussianFilter" = 0,
    #   "medianFilter" = 0
    # ),
    "1" = list(
      "model" = "cyto2",
      # "matchAs" = "nuc",
      "matchAs" = "none",
      "cellDiameter" = 10,
      "cellChannels" = list("Hoechst"),
      "nucChannels" = list(),
      "normalise" = 99,
      "stitchThreshold" = 0.2,
      "mergeLabels" = FALSE,
      "threshold" = 0,
      "relTreshold" = 0,
      "gaussianFilter" = 0,
      "medianFilter" = 0
    )
  ),
  clearDepth = FALSE,
  clearTouchingBorder = FALSE,
  # haloSize = 0,
  # haloWholeCell = FALSE,
  haloSize = 20, # for nuclei expansion
  haloWholeCell = TRUE,
  blockSize = 2048,
  overlap = 120,
  blockSizeZ = -1,
  overlapZ = -1,
  context = 40,
  # segment = TRUE,
  segment = FALSE,
  updateMeasures = FALSE,
  # extendedMeasures = TRUE,
  extendedMeasures = FALSE,
  saveMeshes = FALSE,
  saveMeasures = TRUE,
  labelExpansion = 0,
  labelErosion = 0,
  minCellSize = 50,
  matchThreshold = 0.2,
  removeUnmatched = TRUE
)

# run task
task <- cciaObj$runTask(
  funName = "segment.cellpose",
  funParams = funParams,
  envVars = HPC_CONF,
  hpcDir = paste(hpcDir, pID, "ANALYSIS", sep = "/"),
  env = "hpc",
  # env = "local",
  runInplace = FALSE,
  # runInplace = TRUE,
  taskID = 1
  # taskID = 2
)
```

```{r}
# upload STOMICS
devtools::load_all("../")
cciaUse("~/Desktop/DOHERTY/cecelia", initConda = FALSE, projectsDir = projectsDir)

# init ccia object
cciaObj <- initCciaObject(
  pID = pID, uID = "aSf5Rr", versionID = versionID, initReactivity = FALSE 
)

# run cellpose
# run task
funParams <- list(
)

# run task
task <- cciaObj$runTask(
  funName = "hpc.retrieveCciaObj",
  funParams = funParams,
  envVars = HPC_CONF,
  hpcDir = paste(hpcDir, pID, "ANALYSIS", sep = "/"),
  env = "local",
  runInplace = TRUE,
  taskID = 1
)
```

```{r}
# upload STOMICS
devtools::load_all("../")
cciaUse("~/Desktop/DOHERTY/cecelia", initConda = FALSE, projectsDir = projectsDir)

# init ccia object
cciaObj <- initCciaObject(
  pID = pID, uID = "aSf5Rr", versionID = versionID, initReactivity = FALSE 
)

# run task
funParams <- list(
  specialType = "tenxXenium",
  isSequence = FALSE
)

task <- cciaObj$runTask(
  funName = "importImages.upload",
  funParams = funParams,
  env = "local",
  runInplace = TRUE,
  taskID = 1
)
```

```{r}
# import STOMICS
devtools::load_all("../")
cciaUse("~/Desktop/DOHERTY/cecelia", initConda = FALSE, projectsDir = projectsDir)

# init ccia object
cciaObj <- initCciaObject(
  pID = pID, uID = "aSf5Rr", versionID = versionID, initReactivity = FALSE 
)

# run task
funParams <- list(
  filterValue = 4
)

task <- cciaObj$runTask(
  funName = "importImages.tenxXenium",
  funParams = funParams,
  env = "hpc",
  runInplace = FALSE,
  taskID = 1
)
```

```{r}
devtools::load_all("../")
cciaUse("~/Desktop/DOHERTY/cecelia", initConda = FALSE)

# init ccia object
cciaObj <- initCciaObject(
  pID = pID, uID = "aSf5Rr", versionID = versionID, initReactivity = FALSE
)

# run task
funParams <- list(
  valueName = "stroma",
  dilationSize = 1
)

# run task
task <- cciaObj$runTask(
  funName = "segment.createBranching",
  funParams = funParams,
  env = "local",
  runInplace = TRUE,
  taskID = 1
)
```

```{r}
# get branching of stroma network
devtools::load_all("../")
cciaUse("~/Desktop/DOHERTY/cecelia", initConda = FALSE, projectsDir = projectsDir)

# init ccia object
cciaObj <- initCciaObject(
  pID = pID, uID = "aSf5Rr", versionID = versionID, initReactivity = FALSE 
)

branchingDT <- as.data.table(cciaObj$labelProps(valueName = "stroma.branch")$as_df())
```

```{r fig_branching, fig.height=5, fig.width=13}
# show branching of stroma network
ggplot(branchingDT, aes(`coord-dst-2`, `coord-dst-1`, color = as.factor(`branch-type`))) +
  theme_classic() +
  geom_point(size = 0.5) +
  coord_fixed() +
  scale_color_brewer(palette = "Set1") +
  plotThemeDark(angle = 0)

ggsave(file.path(anaDir, 'stroma', 'n22foC_branching_type.png'), height = 20, width = 30)
```

```{r}
# get populations and show maps
devtools::load_all("../")
cciaUse("~/Desktop/DOHERTY/cecelia", initConda = FALSE, projectsDir = projectsDir)

# init ccia object
cciaObj <- initCciaObject(
  pID = pID, uID = "aSf5Rr", versionID = versionID, initReactivity = FALSE
)

# get label properties
labelDT <- as.data.table(cciaObj$labelProps("stroma")$as_df())

colnames(labelDT)
```

```{r}
# summaryDT <- labelDT %>% pivot_longer(
#   cols = c(
#     "eccentricity", "orientation", "extent", "solidity", "oblate",
#     "prolate", "aspect_ratio", "fill", "solidity"),
#   names_to = "measure",
#   values_to = "value"
# )
```

```{r fig_stroma, fig.height=5, fig.width=8}
# filter 
summaryDT <- labelDT[eccentricity > quantile(labelDT$eccentricity, probs = 0.05)[[1]]]

# plot shape of stroma
for (x in c("eccentricity", "orientation", "extent", "solidity", "oblate",
            "prolate", "aspect_ratio", "fill", "solidity", "aspect_ratio")) {
  limY <- quantile(summaryDT[[x]], probs = 0.98)[[1]]
  
  p1 <- ggplot(summaryDT, aes(centroid_x, centroid_y, color = get(x))) +
    theme_classic() +
    plotThemeDark(angle = 0) +
    geom_point(size = 0.5) +
    coord_fixed() +
    viridis::scale_colour_viridis(limits = c(0, limY)) +
    ggtitle(x)
  
  print(p1)
}
```

