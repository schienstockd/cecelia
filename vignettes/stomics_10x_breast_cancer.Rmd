---
title: "Run modules"
output: html_document
date: '2022-08-16'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Examples to run functions and modules

```{r}
# set test variables
pID <- "5g6H4F"
versionID <- 1
projectsDir <- "/Volumes/Analysis_SSD/Dominik/cecelia/projects/"
```

```{r}
anaDir <- "/Volumes/USER_data/Dominik/Experiments/stomics/10x/ANALYSIS"
```

```{r}
# Load cluster data
devtools::load_all("../")
cciaUse("~/Desktop/DOHERTY/cecelia")

library(ggplot2)
library(tidyverse)
```

```{r}
# HPC config
HPC_CONF <-  list(
  hpc = list(
    conf = list(
      email = "schienstockd@student.unimelb.edu.au",
      emailOnBegin = FALSE,
      emailOnEnd = FALSE,
      emailOnFail = TRUE,
      numNodes = 1,
      numTasks = 1,
      numCPUperTask = 1,
      numGPUperTask = 1,
      memory = 50,
      walltime = "00-04:00:00",
      # walltime = "01-00:00:00",
      # projectPartitions = "physical",
      # projectID = "punim1124",
      # useGPU = FALSE
      projectPartitions = "gpu-a100",
      projectID = "punim1031",
      useGPU = TRUE
    )
  ),
  utils = list(
    ssh = list(
      username = "schienstockd",
      address = "spartan.hpc.unimelb.edu.au",
      keyfile = "/Users/schiend/.ssh/spartan_rsa"
    ),
    python = list(
      condaEnv = cciaConf()$python$conda$source$env
    )
  )
)
```

```{r}
# upload STOMICS
devtools::load_all("../")
cciaUse("~/Desktop/DOHERTY/cecelia", initConda = FALSE, projectsDir = projectsDir)

# init ccia object
cciaObj <- initCciaObject(
  pID = pID, uID = "aSf5Rr", versionID = versionID, initReactivity = FALSE 
)

# run cellpose
# run task
funParams <- list(
)

# run task
task <- cciaObj$runTask(
  funName = "hpc.uploadCciaObj",
  funParams = funParams,
  envVars = HPC_CONF,
  hpcDir = paste(hpcDir, pID, "ANALYSIS", sep = "/"),
  env = "local",
  runInplace = TRUE,
  taskID = 1
)
```


```{r}
# upload STOMICS
devtools::load_all("../")
cciaUse("~/Desktop/DOHERTY/cecelia", initConda = FALSE, projectsDir = projectsDir)

# init ccia object
cciaObj <- initCciaObject(
  pID = pID, uID = "aSf5Rr", versionID = versionID, initReactivity = FALSE 
)

# run cellpose
# run task
funParams <- list(
  valueName = "default",
  # valueName = "stroma",
  models = list(
    # "1" = list(
    #   "model" = "ccia.fluo",
    #   "matchAs" = "none",
    #   "cellDiameter" = 10,
    #   "cellChannels" = list("ALDH1 A3", "GJB2", "LUM", "MMP2", "POSTN", "SFRP4"),
    #   "nucChannels" = list(),
    #   "normalise" = 95,
    #   "stitchThreshold" = 0.2,
    #   # "mergeLabels" = FALSE,
    #   "mergeLabels" = TRUE,
    #   "threshold" = 1,
    #   "relTreshold" = 0,
    #   "gaussianFilter" = 0,
    #   "medianFilter" = 0
    # )
    # "1" = list(
    #   "model" = "cyto2",
    #   "matchAs" = "cyto",
    #   # "matchAs" = "none",
    #   "cellDiameter" = 10,
    #   "cellChannels" = list(
    #     "APOC1", "C15orf48", "C1QA", "C1QC", "CD14",
    #     "CD163", "CD68", "FGL2", "ITGAX", "MMP12",
    #     "CCR7", "CD83", "IL3RA", "LILRA4", "PLD4",
    #     "BANK1", "CD79A", "MS4A1", "CCL5", "CD4",
    #     "CD8A", "CXCR4", "CYTIP", "LTB", "TRAC"),
    #   "nucChannels" = list("Hoechst"),
    #   "normalise" = 99,
    #   "stitchThreshold" = 0.2,
    #   "mergeLabels" = FALSE,
    #   "threshold" = 1,
    #   "relTreshold" = 0,
    #   "gaussianFilter" = 0,
    #   "medianFilter" = 0
    # ),
    "1" = list(
      "model" = "cyto2",
      # "matchAs" = "nuc",
      "matchAs" = "none",
      "cellDiameter" = 10,
      "cellChannels" = list("Hoechst"),
      "nucChannels" = list(),
      "normalise" = 99,
      "stitchThreshold" = 0.2,
      "mergeLabels" = FALSE,
      "threshold" = 0,
      "relTreshold" = 0,
      "gaussianFilter" = 0,
      "medianFilter" = 0
    )
  ),
  clearDepth = FALSE,
  clearTouchingBorder = FALSE,
  # haloSize = 0,
  # haloWholeCell = FALSE
  haloSize = 5, # for nuclei expansion
  haloWholeCell = TRUE,
  blockSize = 2048,
  overlap = 120,
  blockSizeZ = -1,
  overlapZ = -1,
  context = 40,
  segment = TRUE,
  updateMeasures = FALSE,
  # extendedMeasures = TRUE,
  extendedMeasures = FALSE,
  saveMeshes = FALSE,
  labelExpansion = 0,
  labelErosion = 0,
  minCellSize = 50,
  matchThreshold = 0.2,
  removeUnmatched = TRUE
)

# run task
task <- cciaObj$runTask(
  funName = "segment.cellpose",
  funParams = funParams,
  envVars = HPC_CONF,
  hpcDir = paste(hpcDir, pID, "ANALYSIS", sep = "/"),
  env = "hpc",
  # env = "local",
  runInplace = FALSE,
  # runInplace = TRUE,
  # taskID = 1
  taskID = 2
)
```

```{r}
# upload STOMICS
devtools::load_all("../")
cciaUse("~/Desktop/DOHERTY/cecelia", initConda = FALSE, projectsDir = projectsDir)

# init ccia object
cciaObj <- initCciaObject(
  pID = pID, uID = "aSf5Rr", versionID = versionID, initReactivity = FALSE 
)

# run cellpose
# run task
funParams <- list(
)

# run task
task <- cciaObj$runTask(
  funName = "hpc.retrieveCciaObj",
  funParams = funParams,
  envVars = HPC_CONF,
  hpcDir = paste(hpcDir, pID, "ANALYSIS", sep = "/"),
  env = "local",
  runInplace = TRUE,
  taskID = 1
)
```


```{r}
# upload STOMICS
devtools::load_all("../")
cciaUse("~/Desktop/DOHERTY/cecelia", initConda = FALSE, projectsDir = projectsDir)

# init ccia object
cciaObj <- initCciaObject(
  pID = pID, uID = "aSf5Rr", versionID = versionID, initReactivity = FALSE 
)

# run task
funParams <- list(
  specialType = "tenxXenium",
  isSequence = FALSE
)

task <- cciaObj$runTask(
  funName = "importImages.upload",
  funParams = funParams,
  env = "local",
  runInplace = TRUE,
  taskID = 1
)
```

```{r}
# import STOMICS
devtools::load_all("../")
cciaUse("~/Desktop/DOHERTY/cecelia", initConda = FALSE, projectsDir = projectsDir)

# init ccia object
cciaObj <- initCciaObject(
  pID = pID, uID = "aSf5Rr", versionID = versionID, initReactivity = FALSE 
)

# run task
funParams <- list(
  filterValue = 4
)

task <- cciaObj$runTask(
  funName = "importImages.tenxXenium",
  HPC_CONF
  funParams = funParams,
  env = "hpc",
  runInplace = FALSE,
  taskID = 1
)
```

```{r}
# can you generate maps to show XCR1, P14 and LCMV? Then,
# a) Show whether P14 are more associated with XCR1 and P14
# b) Show whether P14 are in T cell, B cell or other area

# ie, showing direct interactions of cells and where these cells are in general
# First generate maps with the actual populations to show distribution 
# for all LCMV images; Also show actual image of P14 in XCR1 area or LCMV associated
# To say that P14 also cluster around LCMV in presence of XCR1
```

```{r fig_gating, fig.height=3, fig.width=5}
# get populations and show maps
devtools::load_all("../")
cciaUse("~/Desktop/DOHERTY/cecelia", initConda = FALSE, projectsDir = projectsDir)

# init ccia object
cciaObj <- initCciaObject(
  pID = pID, uID = "6QzZsl", versionID = versionID, initReactivity = FALSE
)

exp.info <- as.data.table(cciaObj$summary(withSelf = FALSE, fields = c("Attr")))

# only get first LCMV samples
uIDs <- exp.info$uID[1:3]

pops <- cciaObj$popPaths(popType = "flow", uIDs = uIDs, includeFiltered = TRUE)

# exclude 'O' pops
pops <- pops[is.na(str_match(pops, "/O[0-9]*$"))]
# pops <- pops[pops != "/nonDebris"]

# get pops
popDT <- cciaObj$popDT(popType = "flow", uIDs = uIDs, pops = pops, includeFiltered = TRUE)
```

```{r fig_maps, fig.height=3, fig.width=6}
# show XCR1, LCMV and P14?
ggplot(popDT,
       aes(centroid_x, centroid_y)) +
  # geom_point(data = popDT %>% dplyr::filter(pop == "/nonDebris/XCR1"), color = "magenta") +
  geom_point(data = popDT %>% dplyr::filter(pop == "/nonDebris/O/O1/O2/B"), color = "cyan") +
  geom_point(data = popDT %>% dplyr::filter(pop == "/nonDebris/O/LCMV"), color = "green") +
  geom_point(data = popDT %>% dplyr::filter(pop == "/nonDebris/P14"), color = "white") +
  theme_classic() +
  scale_color_brewer(name = NULL, palette = "Dark2") +
  coord_fixed() +
  facet_grid(.~uID) +
  plotThemeDark() +
  theme(
    axis.text = element_text(size = 15),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.line = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.justification = "center",
    legend.position = "bottom"
  )

ggsave(file.path(anaDir, "pops.pdf"), width = 14, height = 6)
```

```{r}
# show with which cells P14 are in contact
# get regions
spatialDT <- cciaObj$spatialDT(valueName = "default", uIDs = uIDs)
# regionsDT <- cciaObj$popDT(popType = "region", uIDs = uIDs, includeFiltered = TRUE)

# join pops
# regionsDT[popDT[, c("uID", "label", "pop")],
#           on = c("uID", "label"),
#           from.pop := i.pop]
spatialDT[popDT[, c("uID", "label", "pop")],
          on = c("uID", "to" = "label"),
          pop.to := pop]
spatialDT[popDT[, c("uID", "label", "pop")],
          on = c("uID", "from" = "label"),
          pop.from := pop]

unique(spatialDT$pop.to)
```

```{r}
# now where are P14?
summaryDT <- copy(spatialDT)
summaryDT[pop.to %in% c(
  "/nonDebris/O/B", "/nonDebris/O/O1/CD3", "/nonDebris"
), ]$pop.to <- "Other"

summaryDT[pop.from == "/nonDebris/P14/clustered",]$pop.from <- "clustered"
summaryDT[pop.from == "/nonDebris/P14/non.clustered",]$pop.from <- "non.clustered"
summaryDT[pop.to == "/nonDebris/P14/clustered",]$pop.to <- "clustered"
summaryDT[pop.to == "/nonDebris/P14/non.clustered",]$pop.to <- "non.clustered"
summaryDT[pop.to == "/nonDebris/O/LCMV",]$pop.to <- "LCMV"
summaryDT[pop.to == "/nonDebris/XCR1",]$pop.to <- "XCR1"

summaryDT <- summaryDT %>%
  dplyr::filter(
    pop.from %in% c("clustered", "non.clustered"),
    !pop.to %in% c("clustered", "non.clustered")
      # "/nonDebris/XCR1", "/nonDebris/O/LCMV"),
    # pop.to %in% c("/nonDebris", "/nonDebris/XCR1", "/nonDebris/O/LCMV")
    # !pop.to %in% c("/nonDebris/O/O1/O2/B")
    ) %>%
  group_by(uID, pop.from, pop.to) %>%
  dplyr::summarise(n = n()) %>%
  mutate(freq = n/sum(n) * 100) %>%
  drop_na() %>%
  ungroup() %>%
  complete(uID, pop.from, pop.to, fill = list(freq = 0))
  # mutate(pop.group = interaction(uID, pop.to))
```


```{r fig_clusters_heat, fig.height=1, fig.width=2}
ggplot(data = summaryDT %>%
         mutate(
           pop.to = factor(pop.to, levels = c("XCR1", "LCMV", "Other")),
           pop.from = factor(pop.from, levels = c("non.clustered", "clustered"))
           ),
       aes(
         # color = as.factor(pop.from),
         y = freq,
         # x = as.factor(pop.to))) +
         x = pop.from)) +
  theme_classic() +
  geom_boxplot(outlier.alpha = 0) +
  # geom_jitter(position = position_jitterdodge(jitter.width = 0.10), alpha = 1.0) +
  # geom_jitter(width = 0.3, alpha = 1.0) +
  geom_point(alpha = 1.0) +
  theme(
    legend.justification = "center",
    legend.direction = "horizontal",
    legend.position = "bottom",
    legend.title = element_blank(),
    axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1)
  ) +
  geom_line(aes(group = interaction(uID, pop.to))) +
  xlab("") + ylab("Interaction (%)") +
  facet_wrap(~pop.to, nrow = 1, scales = "free_y") +
  expand_limits(y = 0)

ggsave(file.path(anaDir, "P14_interactions.pdf"), width = 3, height = 2)
```


